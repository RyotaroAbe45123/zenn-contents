---
title: "Nand2Tetris ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ç·¨"
emoji: "ğŸ–¥ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CPU", "nand2tetris", "hardware", "computer_architecture"]
published: true
---

# Nand2Tetris ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ç·¨: 1~5ç« ã®å®Ÿè£…ã¨ãƒãƒã‚Šã©ã“ã‚

## ã“ã®è¨˜äº‹ã®æ¦‚è¦
æœ¬è¨˜äº‹ã§ã¯ã€Nand2Tetris ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢éƒ¨åˆ†ã«ç„¦ç‚¹ã‚’å½“ã¦ã€åŸºæœ¬çš„ãª NAND ã‚²ãƒ¼ãƒˆã‹ã‚‰å§‹ã‚ã¦ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ä¸»è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã©ã®ã‚ˆã†ã«æ§‹ç¯‰ã™ã‚‹ã‹ã‚’è§£èª¬ã—ã¾ã™ã€‚ç‰¹ã« **1~5ç« ã®å®Ÿè£…éç¨‹** ã‚’è§£èª¬ã—ã€ç­†è€…ãŒèº“ã„ãŸãƒã‚¤ãƒ³ãƒˆã‚„æ³¨æ„ç‚¹ã‚’å…±æœ‰ã—ã¾ã™ã€‚

- **å¯¾è±¡èª­è€…**
  - éæƒ…å ±ç³»å‡ºèº«è€…
  - ä»•äº‹ã‚„è¶£å‘³ã§ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã¯ã—ã¦ã„ã‚‹ãŒã€ã„ã¤ã‹ã˜ã£ãã‚Šã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ä»•çµ„ã¿ã‚’å‹‰å¼·ã—ãŸã„ãªã¨æ€ã£ã¦ã„ãŸæ–¹
  - æ‰‹ã‚’å‹•ã‹ã—ãªãŒã‚‰å­¦ã¶ã®ãŒå¥½ããªæ–¹


æœ¬æ›¸ã‚’é€šã˜ã¦ä½œæˆã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€GitHub ã«å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚
https://github.com/RyotaroAbe45123/nand2tetris

## Nand2Tetris ã¨ã¯ï¼Ÿ
[Nand2Tetris](https://www.nand2tetris.org/) ã¯ã€NANDã‚²ãƒ¼ãƒˆã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã€å¾ã€…ã«ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãŠã‚ˆã³ãã®ã†ãˆã§å‹•ä½œã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹å­¦ç¿’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚
ä¸Šè¨˜ã¯ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆä¸Šã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå…¬é–‹ã•ã‚Œã¦ãŠã‚Šã€ãã‚Œã¨ã¯åˆ¥ã«æ—¥æœ¬èªæ›¸ç±ã‚‚å‡ºç‰ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
https://www.oreilly.co.jp/books/9784873117126/

ç¬¬2ç‰ˆãŒ2021å¹´ã«å‡ºç‰ˆã•ã‚Œã€ãã®é‚¦è¨³ç‰ˆãŒ2024å¹´ã«ç™ºå£²ã•ã‚Œã¾ã—ãŸã€‚
ãã®éš›ã®ã€ç¿»è¨³ã‚’æ–è—¤åº·æ¯…ã•ã‚“ãŒæ‹…å½“ã•ã‚Œã¾ã—ãŸã€‚
ã“ã®æ–¹ã¯ã€[ã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹Deep Learning](https://www.oreilly.co.jp/books/9784873117584/)ã®è‘—è€…ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚
ç§ã‚‚æ˜”ã€ã“ã®æœ¬ã§æ‰‹ã‚’å‹•ã‹ã—ãªãŒã‚‰å‹‰å¼·ã•ã›ã¦ã‚‚ã‚‰ã£ãŸè¨˜æ†¶ãŒã‚ã‚Šã€ãã‚ŒãŒå¤§å¤‰ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã®ã§ã€ä»Šå›Nand2Tetrisã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
https://x.com/SaitohKoki/status/1863373192133476410

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® **ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ç·¨ï¼ˆ1~5ç« ï¼‰** ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã§ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

## 1~5ç« ã®ã‚¢ã‚¸ã‚§ãƒ³ãƒ€
| ç«  | å†…å®¹ | å®Ÿè£…ã™ã‚‹ã‚‚ã® |
|----|------|------------|
| 1ç«  | ãƒ–ãƒ¼ãƒ«è«–ç† | ANDãƒ»ORãƒ»NOTãªã©ã®åŸºæœ¬ã‚²ãƒ¼ãƒˆ |
| 2ç«  | ãƒ–ãƒ¼ãƒ«æ¼”ç®— | åŠ ç®—å™¨ãƒ»ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãªã©ã‹ã‚‰16bitALU |
| 3ç«  | ãƒ¡ãƒ¢ãƒª | å®Ÿè£…æ¸ˆã¿Dãƒ•ãƒªãƒƒãƒ—ãƒ•ãƒ­ãƒƒãƒ—ã‚’ç”¨ã„ã¦ã€1bitãƒ¬ã‚¸ã‚¹ã‚¿ã‹ã‚‰16KRAM |
| 4ç«  | æ©Ÿæ¢°èª | Hackã‚¢ã‚»ãƒ³ãƒ–ãƒªã§åŠ ç®—ã€ä¹—ç®—ã€I/O |
| 5ç«  | ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | ã“ã‚Œã¾ã§ä½œæˆã—ãŸMemory, CPUãªã©ã‹ã‚‰Hackã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’ |

ä»¥ä¸‹ã®å›³ã®ã‚ˆã†ã«ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚·ã‚¹ãƒ†ãƒ ã¯å¤§ãããƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¨ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã«åˆ†ã‘ã‚‰ã‚Œã¾ã™ã€‚(å„ç•ªå·ãŒå„ç« ã¨å¯¾å¿œã—ã¦ã„ã‚‹)
ã‚ˆã£ã¦ã€1ç« ã§NANDã‹ã‚‰ä¸€é€šã‚Šã®åŸºæœ¬ã‚²ãƒ¼ãƒˆã‚’ä½œæˆã—ã€2, 3ç« ã§ALUã‚„ãƒ¡ãƒ¢ãƒªã®ãƒãƒƒãƒ—ã‚’ä½œæˆã€4ç« ã®Hackæ©Ÿæ¢°èªã«æ²¿ã£ã¦ã€5ç« ã§ã“ã‚Œã¾ã§ä½œæˆã—ã¦ããŸãƒ‘ãƒ¼ãƒ„ã‚’ç”¨ã„ã¦Hackã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹æµã‚Œã§ã™ã€‚

![overall](/images/4/01_overall.jpg =500x)
*å›³â… -1ã‚ˆã‚Šå¼•ç”¨ï¼šã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚·ã‚¹ãƒ†ãƒ ã®ä¸»è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«*

---

## 1ç« : ãƒ–ãƒ¼ãƒ«è«–ç†
### ã‚´ãƒ¼ãƒ«ï¼šåŸºæœ¬ã‚²ãƒ¼ãƒˆã®å®Ÿè£…
1ç« ã§ã¯ã€çœŸç†å€¤è¡¨ã‹ã‚‰åŸºæœ¬ã‚²ãƒ¼ãƒˆã‚’ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢è¨˜è¿°è¨€èª (Hardware Description Language: HDL) ã§è¨˜è¿°ã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§å‹•ä½œæ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚
ã“ã“ã§ä½œæˆã™ã‚‹ã®ã¯ã€AND, AND16bit, DMux, DMux4way, Dmux8way, Mux, Mux16bit, Mux4way16bit, Mux8way16bit, Not, Not16bit, Or, Or16bit, Or8way, Or16bit ã§ã™ã€‚
ä¾‹ã¨ã—ã¦ã€ANDã‚²ãƒ¼ãƒˆã®çœŸç†å€¤è¡¨ã¨HDLã‚’è¨˜è¼‰ã—ã¾ã™ã€‚
| a | b | out |
|---|---|-----|
| 0 | 0 | 0 |
| 0 | 0 | 0 |
| 1 | 0 | 0 |
| 1 | 1 | 1 |
```hdl
CHIP And {
    IN a, b;
    OUT out;
    PARTS:
    Nand(a=a, b=b, out=nandOut);
    Nand(a=nandOut, b=nandOut, out=out);
}
```
ä¸Šè¨˜HDLã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§å®Ÿè¡Œã—ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’é€šã™ã“ã¨ã§ã€ANDã‚²ãƒ¼ãƒˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã®æ¤œè¨¼ã‚’åŒæ§˜ã«ã»ã‹ã®åŸºæœ¬ã‚²ãƒ¼ãƒˆã«ã¤ã„ã¦ã‚‚å®Ÿæ–½ã—ã¾ã™ã€‚
å€‹äººçš„ã«ã¯ã€ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¯ã‚µ (Multiplexor: Mux) ã®æ¡ä»¶åˆ†å²ã‚’è«–ç†å›è·¯ã§è¨­è¨ˆã™ã‚‹ã®ãŒé›£ã—ããƒãƒã‚Šã©ã“ã‚ã§ã—ãŸã€‚
:::details Muxã®å®Ÿè£…
```hdl
CHIP Mux
    IN a, b, sel;
    OUT out;

    PARTS:
    // if sel then a, else b
    Not(in=sel, out=notsel);
    And(a=notsel, b=a, out=out1);
    And(a=sel, b=b, out=out2);
    Or(a=out1, b=out2, out=out);
```
:::

HDLã‚’å®Ÿè£…ã—ãŸã‚‰ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’èµ·å‹•ã—ã¦ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’èµ·å‹•ã™ã‚‹ã¨å·¦ã®ç”»é¢ãŒç«‹ã¡ä¸ŠãŒã‚Šã€ãã‚Œã«HDLã¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€ã¨å³ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã‚ã¨ã¯å·¦ã‹ã‚‰2,3ç•ªç›®ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€**End of script - Comparision ended successfully**ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚
| ![](/images/4/02_simulator.png =500x) | ![](/images/4/03_simulator2.png =500x) |
| ----------------------------------------- | ----------------------------------------- |


## 2ç« : ãƒ–ãƒ¼ãƒ«æ¼”ç®—
### ã‚´ãƒ¼ãƒ«ï¼šALUã®å®Ÿè£…
2ç« ã§ã¯ã€ä¸­å¤®æ¼”ç®—è£…ç½® (CPU) ã®ä¸­æ ¸ã§ã‚ã‚‹ç®—è¡“è«–ç†æ¼”ç®—è£…ç½® (ALU) ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
åŠåŠ ç®—å™¨ã€å…¨åŠ ç®—å™¨ã€16bitåŠ ç®—å™¨ã¨å®Ÿè£…ã—ã¦ã€ALU, ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ã®é †ã«ãªã‚Šã¾ã™ã€‚

ALUã®å®Ÿè£…ã¯ä»¥ä¸‹ã®çœŸç†å€¤è¡¨ã«æ²¿ã£ã¦ã€2ã¤ã®å…¥åŠ›ã¨6ã¤ã®åˆ¶å¾¡ãƒ“ãƒƒãƒˆã‚’å—ã‘å–ã£ã¦ã€out, zr, ng ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚zr, ngã¯ã“ã®æ®µéšã§ã¯ä½•ã«ä½¿ã†ã®ãŒã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€5ç« ã®CPUå®Ÿè£…ã§ä½¿ã„ã¾ã™ã€‚
:::details ALUã®çœŸç†å€¤è¡¨
| zx | nx | zy | ny | f | no | out |
| -- | -- | -- | -- | -- | -- | -- |
|  1 |  0 |  1 |  0 |  1 |  0 |  0 |
|  1 |  1 |  1 |  1 |  1 |  1 |  1 |
|  1 |  1 |  1 |  0 |  1 |  0 |  -1 |
|  0 |  0 |  1 |  1 |  0 |  0 |  x |
|  1 |  1 |  0 |  0 |  0 |  0 |  y |
|  0 |  0 |  1 |  1 |  0 |  1 |  !x |
|  1 |  1 |  1 |  0 |  0 |  1 |  !y |
|  0 |  0 |  1 |  1 |  1 |  1 |  -x |
|  1 |  1 |  0 |  0 |  1 |  1 |  -y |
|  0 |  1 |  1 |  1 |  1 |  1 |  x+1 |
|  1 |  1 |  0 |  1 |  1 |  1 |  y+1 |
|  0 |  0 |  1 |  1 |  1 |  0 |  x-1 |
|  1 |  1 |  0 |  0 |  1 |  0 |  y-1 |
|  0 |  0 |  0 |  0 |  1 |  0 |  x+y |
|  0 |  1 |  0 |  0 |  1 |  1 |  x-y |
|  0 |  0 |  0 |  1 |  1 |  1 |  y-x |
|  0 |  0 |  0 |  0 |  0 |  0 |  x&y |
|  0 |  1 |  0 |  1 |  0 |  1 |  x|y |
:::
ALUã®æ¡ä»¶åˆ†å²ã€ç‰¹ã«zr, ngã®å‡ºåŠ›ã‚’ã©ã†ã™ã‚‹ã‹ãŒé›£ã—ã„ã§ã™ãŒã€ãã‚Œä»¥å¤–ã¯æŒ‡ç¤ºã«å¾“ã„ã€ã‚¹ãƒ ãƒ¼ã‚ºã«å®Ÿè£…ãŒã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
å‰è€…ã¯x,yã®â‘ ç­‰å·åˆ¤å®šã€å¾Œè€…ã¯outã®â‘¡ç¬¦å·åˆ¤å®šã§ã™ã€‚
â‘ ç­‰å·åˆ¤å®šã«ã¯XORã‚²ãƒ¼ãƒˆã‚’ä½¿ã„ã¾ã—ãŸã€‚æœ¬å½“ã¯XNORã‚’ç”¨ã„ã‚‹ã¨ã‚‚ã£ã¨ã‚¹ãƒ ãƒ¼ã‚ºã«å®Ÿè£…ã§ããŸã‹ã¨æ€ã„ã¾ã™ãŒã€1ç« ã§å®Ÿè£…ã—ã¦ã„ãªã‹ã£ãŸã®ã§ã€XORã«ã—ã¾ã—ãŸã€‚ï¼ˆãŸã¶ã‚“ã‚‚ã£ã¨ã‚ˆã„å®Ÿè£…æ–¹æ³•ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã®ã§ãœã²ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ï¼‰
â‘¡ç¬¦å·åˆ¤å®šã«ã¯ã€outã®æœ€ä¸Šä½ãƒ“ãƒƒãƒˆã‚’å–ã‚Šå‡ºã—ã¦ã€ngã«ä»£å…¥ã—ã¾ã—ãŸã€‚
å‚è€ƒã¾ã§ã«ç­†è€…ãŒå®Ÿè£…ã—ãŸALUã¯[ã“ã¡ã‚‰](https://github.com/RyotaroAbe45123/nand2tetris/blob/main/02_BooleanArithmetic/ALU.hdl)ã«ãªã‚Šã¾ã™ã€‚


ã¾ãŸã€ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ã‚’åŠ ç®—å™¨ã‚’ç”¨ã„ã¦å®Ÿè£…ã—ã¾ã™ãŒã€ã“ã¡ã‚‰ã¯ã€3ç« ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚«ã‚¦ãƒ³ã‚¿ (PC) ã§ç”¨ã„ã¾ã™ã€‚

## 3ç« : ãƒ¡ãƒ¢ãƒª
### ã‚´ãƒ¼ãƒ«ï¼šRAMã®å®Ÿè£…
ã“ã‚Œã¾ã§ã¯çµ„ã¿åˆã‚ã›å›è·¯ã ã‘ã§ã—ãŸãŒã€ã“ã®ç« ã‹ã‚‰é †åºå›è·¯ãŒç™»å ´ã—ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒªãƒƒãƒ—ãƒ•ãƒ­ãƒƒãƒ— (Data Flip Flop: DFF) ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã«ã‚ˆã£ã¦ã€çŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
DFFã‚’æœ€å°æ§‹æˆã¨ã—ã¦ã€1bitãƒ¬ã‚¸ã‚¹ã‚¿ã€16bitãƒ¬ã‚¸ã‚¹ã‚¿ã€16bitãƒ©ãƒ³ãƒ€ãƒ ã‚¢ã‚¯ã‚»ã‚¹ãƒ¡ãƒ¢ãƒª (Random Access Memory: RAM) ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
æœ€å¾Œã«CPUã§å¿…è¦ã«ãªã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚«ã‚¦ãƒ³ã‚¿ (Program Counter: PC) ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ã¾ãšã¯ã€1bitãƒ¬ã‚¸ã‚¹ã‚¿ã®å®Ÿè£…ã‚’ã—ã¾ã™ã€‚ãƒ¬ã‚¸ã‚¹ã‚¿ã¯ã€loadãƒ“ãƒƒãƒˆãŒ1ã®ã¨ãã«inã®å€¤ã‚’ä¿æŒã—ã€0ã®ã¨ãã«ä¿æŒã—ã¾ã›ã‚“ã€‚
ã“ã®æ¡ä»¶åˆ†å²ã¯1ç« ã§å®Ÿè£…ã—ãŸMuxãŒä½¿ãˆã¾ã™ã€‚ã¾ãŸã€DFFã‚’ç”¨ã„ã¦ã€ãƒ¬ã‚¸ã‚¹ã‚¿ã®çŠ¶æ…‹ã‚’ä¿æŒã—ã¾ã™ã€‚DFFã®å®Ÿè£…ã¯ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ãƒãƒƒãƒ—ã¨ã—ã¦æä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚
åŒæ§˜ã«ã€1bitRegisterã‚’16bitRegisterã«æ‹¡å¼µã—ã€16bitRAMã‚’å®Ÿè£…ã—ã¾ã™ã€‚
ã¾ãŸã€ãã‚Œã‚‰ã‚’ä¸¦åˆ—ã«ã™ã‚‹ã“ã¨ã§ã€16KRAMã‚’å®Ÿè£…ã—ã¾ã™ã€‚
![overall](/images/4/04_register.png =500x)
*Registerã®è«–ç†å›è·¯*
```hdl
CHIP 1BitRegister
    IN in, load;
    OUT out;

    PARTS:
    Mux(a=backward, b=in, sel=load, out=forward);
    DFF(in=forward, out=out, out=backward);
```

ç§ã¯ã“ã®ç« ã§ã¯ã€PCã®å®Ÿè£…ã«ãƒ‰ãƒãƒãƒªã—ã¾ã—ãŸã€‚(ã‚ã¡ã‚ƒãã¡ã‚ƒæ™‚é–“ã‚’æº¶ã‹ã—ã¾ã—ãŸ)
PCã¯å…¥åŠ›ã€å‡ºåŠ›ã€loadãƒ“ãƒƒãƒˆã€incãƒ“ãƒƒãƒˆã€resetãƒ“ãƒƒãƒˆã‹ã‚‰æ§‹æˆã•ã‚Œã¾ã™ã€‚
resetãƒ“ãƒƒãƒˆãŒ1ã®ã¨ãã¯outã¯0ã«ãªã‚Šã€incãƒ“ãƒƒãƒˆãŒ1ã®ã¨ãã¯outã«1ã‚’åŠ ãˆã¾ã™ã€‚loadãƒ“ãƒƒãƒˆãŒ1ã®ã¨ãã¯inã®å€¤ã‚’ä¿æŒã—ã¾ã™ã€‚
ã“ã‚Œã‚‰ã®æ¡ä»¶åˆ†å²ã®å„ªå…ˆåº¦ä»˜ã‘ã«è‹¦æˆ¦ã—ã¾ã—ãŸã€‚
reset > load > incã¨é †ç•ªã¯æ±ºã‚ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã€ã©ã†ã‚„ã£ãŸã‚‰ã“ã®é †ç•ªã‚’å®Ÿè£…ã§ãã‚‹ã‹ãŒé›£ã—ã‹ã£ãŸã§ã™ã€‚
å„ªå…ˆåº¦ãŒé«˜ã„ã¨ã¯ã€è«–ç†å›è·¯ä¸Šã®å…¥åŠ›å´ã‹å‡ºåŠ›å´ã‹ã‚’è€ƒãˆã‚‹ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚åˆ†å²ã«ã¯MuxãŒä½¿ãˆã¾ã™ã€‚
:::details PCã®å®Ÿè£…(å‚è€ƒã¾ã§ã«)
```hdl
CHIP PC
    IN in[16],inc, load, reset;
    OUT out[16];
    
    PARTS:
    Inc16(in=backward, out=incout);
    Mux16(a=backward, b=incout, sel=inc, out=incforward);
    Mux16(a=incforward, b=in, sel=load, out=loadforward);
    Mux16(a=loadforward, b=false, sel=reset, out=resetforward);
    // ã“ã“ã¯DFF16ã§ã‚ã‚Œã°ã‚ˆã„ã®ã ãŒã€å®Ÿè£…ãŒãªãé¢å€’ãªã®ã§ã€Registerã‚’ä»£ç”¨ã™ã‚‹ã€‚ã“ã®ã¨ãloadã«ã¯å¸¸ã«1ã‚’å…¥åŠ›ã™ã‚‹ã€‚
    Register(in=resetforward, load=true, out=out, out=backward);
```
:::

## 4ç« : æ©Ÿæ¢°èª
### ã‚´ãƒ¼ãƒ«ï¼šã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ä½œæˆ
4ç« ã§çªç„¶æ©Ÿæ¢°èªã®è©±ãŒå‡ºã¦ãã¾ã™ã€‚ã‚ã‚Œï¼ŸCPUä½œã‚‹ã‚“ã˜ã‚ƒãªã„ã®ï¼Ÿã¨æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€CPUã‚’ä½œã‚‹ãŸã‚ã«ã¯ã€å‘½ä»¤ãŒã©ã®é †ç•ªã§ã©ã“ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã®ã‹ã‚’ç†è§£ã—ã¦ãŠãã¨ã¨ã¦ã‚‚ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¹§ãã‚„ã™ã„ã§ã™ã€‚
ãªã®ã§ã€å…ˆã‚“ã˜ã¦ã€æ©Ÿæ¢°èªãŠã‚ˆã³ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ä½œæˆã‚’è¡Œã„ã€ãã®å‹•ä½œã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ²¸ã‹ã›ã¦ã„ã‚‹ã®ã ã¨è§£é‡ˆã—ã¾ã—ãŸã€‚
å®Ÿéš›ã€4ç« ã®æ®µéšã§ã¯ã‚ã‹ã‚‰ãªã„ã§ã™ãŒã€5ç« ã®CPUå®Ÿè£…ã®æ®µéšã§ã€ã¨ã¦ã‚‚å½¹ã«ç«‹ã¡ã¾ã—ãŸã€‚ã¾ãŸãã“ã‹ã‚‰4ç« ã«æˆ»ã‚‹ã¨ãªãŠç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚

ã“ã“ã§ã¯ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ¬ã‚¸ã‚¹ã‚¿ã€ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¸ã‚¹ã‚¿ã€ãƒ‡ãƒ¼ã‚¿ãƒ¡ãƒ¢ãƒªã€å‘½ä»¤ãƒ¡ãƒ¢ãƒªã€ã‚¢ãƒ‰ãƒ¬ã‚¹å‘½ä»¤ (Aå‘½ä»¤)ã€è¨ˆç®—å‘½ä»¤ (Cå‘½ä»¤) ã‚’é§†ä½¿ã—ã¦ä¹—ç®—ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
ã„ã¤ã‚‚é«˜ç´šè¨€èªã§foræ–‡ã¨ã‹whileãƒ«ãƒ¼ãƒ—ã¨ã‹é©å½“ã«ä½¿ã£ã¦ã„ã‚‹ã®ãŒã€ã“ã“ã§ã¯ã€æœ¬å½“ã«ã²ã¨ã¤ãšã¤ã®å‡¦ç†ã‚’é †ç•ªã«ã—ã‹å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚ä¸€æ–¹ã§å®Œå…¨ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã¦ã„ã‚‹æ„Ÿã˜ãŒã—ã¦ã€ã¨ã¦ã‚‚æ¥½ã—ã„ã§ã™ã€‚

ä»¥ä¸‹ã«åŠ ç®—ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚
ã“ã‚Œã¯ã€RAM[2] = RAM[0] + RAM[1] + 17 ã‚’å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã€‚
å‡¦ç†ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ²¸ã‹ãªã„å ´åˆã¯ã€ã²ã¨ã¤ãšã¤å‡¦ç†å†…å®¹ã‚’è¨˜è¼‰ã—ã¦å‹•ä½œã‚’ç…§ã‚‰ã—åˆã‚ã›ã‚‹ã¨ç†è§£ã—ã‚„ã™ã„ã§ã™ã€‚
```asm
    @R0 -> RAM[0]ã«ã‚¢ã‚¯ã‚»ã‚¹
    D=M -> ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¸ã‚¹ã‚¿ã«RAM[0]ã‹ã‚‰èª­ã¿å–ã£ãŸå€¤ã‚’æ ¼ç´
    @R1 -> RAM[1]ã«ã‚¢ã‚¯ã‚»ã‚¹
    D=D+M -> ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¸ã‚¹ã‚¿ã«RAM[1]ã‹ã‚‰èª­ã¿å–ã£ãŸå€¤ã‚’æ—¢å­˜ã®å€¤ã«åŠ ç®—
    @17 -> RAM[17]ã«ã‚¢ã‚¯ã‚»ã‚¹
    D=D+A -> ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¸ã‚¹ã‚¿ã«17ã‚’åŠ ç®—
    @R2 -> RAM[2]ã«ã‚¢ã‚¯ã‚»ã‚¹
    M=D -> RAM[2]ã«ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¸ã‚¹ã‚¿ã®å€¤ã‚’æ ¼ç´
(END)
    @END
    0;JMP
```

ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚’å®Ÿè£…ã—ãŸã‚‰ã€CPUã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’èµ·å‹•ã—ã¦ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ã‚¢ã‚»ãƒ³ãƒ–ãƒ©ã¯å®Ÿè£…ã›ãšã¨ã‚‚ä¸Šè¨˜ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ä¸Šã§ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
ã“ã“ã§1ã¤ãšã¤å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã¦ã„ãã¨ã€ã©ã®é †ç•ªã§å‘½ä»¤ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã®ã‹ã‚’è¿½ã†ã“ã¨ãŒã§ãã‚‹ã®ã§ã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚ï¼ˆç›®ã§è¿½ã†ã ã‘ã§ã‚‚æ¥½ã—ã„ã€‚æƒ³å®šé€šã‚Šã«å‹•ä½œã™ã‚‹ã¨ã‚ã£ã¡ã‚ƒã†ã‚Œã—ã„ã€‚ï¼‰
| ![](/images/4/05_cpuemulator.png =500x) | ![](/images/4/06_cpuemulator2.png =500x) |
| ----------------------------------------- | ----------------------------------------- |

## 5ç« : ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
### Hackã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®å®Ÿè£…
ã“ã“ã¾ã§ã§ä½œæˆã—ãŸã‚‚ã®ã‚’æ´»ç”¨ã—ã€CPU, Memoryã‚’ä½œæˆã—ã€ãã‚Œã‚‰ã‚’çµ„ã¿åˆã‚ã›ã¦ã€Hackã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
Hackã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¯ã“ã‚Œã‚‰ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«çµ„ã¿åˆã‚ã›ãŸã‚‚ã®ãªã®ã§ã€ã‚ã¾ã‚Šã¤ã¾ã‚Šã©ã“ã‚ã¯ãªã„ã¨æ€ã„ã¾ã™ã€‚
```hdl
CHIP Computer
    IN reset;

    PARTS:
    ROM32K(address=pc, out=instruction);
    CPU(
        inM=inM, instruction=instruction, reset=reset,
        outM=outM, writeM=writeM, addressM=addressM, pc=pc
    );
    Memory(in=outM, load=writeM, address=addressM, out=inM);
```

ä¸€æ–¹ã§ã€CPUã®å®Ÿè£…ãŒæœ€ã‚‚é›£ã—ã‹ã£ãŸã§ã™ã€‚
3ç« ã§ä½œæˆã—ãŸãƒ‘ãƒ¼ãƒ„ã‚„4ç« ã§å®Ÿè£…ã—ãŸã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ä»•æ§˜ã‹ã‚‰ã€CPUã®å‹•ä½œã‚¤ãƒ¡ãƒ¼ã‚¸ã¯æ¹§ãã¨æ€ã„ã¾ã™ã€‚
ãã‚Œã‚‰ã‚’16bitã®instructionã®å…¥åŠ›ã«åˆã‚ã›ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¸ã‚¹ã‚¿ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ¬ã‚¸ã‚¹ã‚¿ã€ALUã€PCã«æ¥ç¶šã—ã¦ã„ãã¾ã™ã€‚
ã“ã®åˆ†å²ãŒè¤‡é›‘ã§ã€ãƒ†ã‚¹ãƒˆã‚’é€šã™ã¾ã§ã«ä½•åº¦ã‚‚ä¿®æ­£ã—ã¾ã—ãŸã€ã€ã€
ã²ã¨ã¤ãšã¤ä»•æ§˜ã¨ç…§ã‚‰ã—åˆã‚ã›ã‚‹ã¨æ™‚é–“ãŒã‹ã‹ã‚‹ã¨ã¯æ€ã„ã¾ã™ãŒã€ãƒ†ã‚¹ãƒˆã‚’é€šã™ã“ã¨ã¯ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
![cpu](/images/4/07_cpu.jpg =750x)
*å›³5-8ã‚ˆã‚Šå¼•ç”¨ï¼šHack CPUã®å®Ÿè£…æ¡ˆ*

ä»¥ä¸‹ã«CPUã®HDLã‚’è¨˜è¼‰ã—ã¾ã™ã€‚æ³¨æ„ç‚¹ã¨ã—ã¦ã¯ã€Registerã®ä½¿ã„å›ã—ã§ã¯ãªãã€ARegister, DRegisterã‚’ä½¿ã†ã“ã¨ã§ã™ã€‚
ã¾ãŸã€jumpåˆ¤å®šã®éƒ¨åˆ†ã®æ¡ä»¶åˆ†å²ãŒè¤‡é›‘ã§ã™ãŒã€4ç« ã§ç”¨ã„ãŸHackå‘½ä»¤ã‚»ãƒƒãƒˆã¨jjjãƒ“ãƒƒãƒˆ(ã‚¸ãƒ£ãƒ³ãƒ—å‘½ä»¤), zrãƒ“ãƒƒãƒˆ, ngãƒ“ãƒƒãƒˆã‚’ç…§ã‚‰ã—åˆã‚ã›ã‚‹ã“ã¨ã§ã€å®Ÿè£…ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚ã“ã“ã§ã®zr, ngã¯ALUã®å‡ºåŠ›ã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚(ã“ã“ã§ä½¿ã†ã®ã‹ã¨æ€ã„ã¾ã—ãŸï¼)
```hdl
CHIP CPU {

    IN  inM[16],         // M value input  (M = contents of RAM[A])
        instruction[16], // Instruction for execution
        reset;           // Signals whether to re-start the current
                         // program (reset==1) or continue executing
                         // the current program (reset==0).

    OUT outM[16],        // M value output
        writeM,          // Write to M? 
        addressM[15],    // Address in data memory (of M)
        pc[15];          // address of next instruction

    PARTS:
    // è¨ˆç®—çµæœã‚’Aãƒ¬ã‚¸ã‚¹ã‚¿ã«æ ¼ç´ã™ã‚‹ã‹ã©ã†ã‹
    // dddã®æœ€ä¸Šä½ãƒ“ãƒƒãƒˆãŒ1ã®ã¨ãã€destã«AãŒå«ã¾ã‚Œã‚‹ã®ã§ã€ãã®åˆ¤æ–­ã‚’Muxã§å®Ÿæ–½
    Mux16(a=instruction, b=aluOut, sel=instruction[15], out=forward1);
    // ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ¬ã‚¸ã‚¹ã‚¿ã«Aå‘½ä»¤ã‚’æ ¼ç´ã™ã‚‹ã‹ã©ã†ã‹ã€‚æœ€ä¸Šä½ãƒ“ãƒƒãƒˆãŒ1ãªã‚‰Aå‘½ä»¤ãªã®ã§ã€æ ¼ç´ã™ã‚‹ã€‚
    Not(in=instruction[15], out=aInstructionFlag);
    // Cå‘½ä»¤ã‹ã¤destã«AãŒå«ã¾ã‚Œã‚‹å ´åˆã‚‚
    And(a=instruction[15], b=instruction[5], out=cInstructionAndAInDest);
    Or(a=aInstructionFlag, b=cInstructionAndAInDest, out=aRegisterLoad);
    ARegister(
        in=forward1, load=aRegisterLoad,
        out=aRegisterOut, out[0..14]=addressM
    );
    // ALUã®å…¥åŠ›ãŒã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ¬ã‚¸ã‚¹ã‚¿ã‹ãƒ‡ãƒ¼ã‚¿ãƒ¡ãƒ¢ãƒªã‹ã‚‰ã‹ã‚’åˆ¤å®š
    Mux16(a=aRegisterOut, b=inM, sel=instruction[12], out=yToALU);

    DRegister(in=aluOut, load=instruction[4], out=xToALU);
    ALU(
        x=xToALU, y=yToALU,
        zx=instruction[11], nx=instruction[10],
        zy=instruction[9], ny=instruction[8],
        f=instruction[7], no=instruction[6],
        out=aluOut, out=outM,
        zr=zr, ng=ng
    );
    And(a=instruction[15], b=instruction[3], out=writeM);

    PC(
        in=aRegisterOut,
        load=pcLoadFlag, inc=pcIncFlag, reset=reset,
        out[0..14]=pc
    );
    // jumpåˆ¤å®š
    Not(in=zr, out=notZr);
    Not(in=ng, out=notNg);
    And(a=instruction[2], b=instruction[1], out=out1);
    And(a=instruction[0], b=out1, out=out11);
    And(a=zr, b=instruction[1], out=out2);
    And(a=ng, b=instruction[2], out=out3);
    And(a=notZr, b=notNg, out=out4);
    And(a=instruction[0], b=out4, out=out44);
    Or(a=out11, b=out2, out=out12);
    Or(a=out3, b=out44, out=out34);
    Or(a=out12, b=out34, out=pcLoad);
    And(a=pcLoad, b=instruction[15], out=pcLoadFlag);
    Not(in=pcLoadFlag, out=pcIncFlag);
}
```

## ã¾ã¨ã‚
1~5ç« ã‚’é€šã˜ã¦ã€Nand2Tetrisã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ç·¨ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Hackæ©Ÿæ¢°èªã®å‹•ä½œã™ã‚‹Hackã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’NANDã‚²ãƒ¼ãƒˆã‹ã‚‰æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
NANDã‚²ãƒ¼ãƒˆã‹ã‚‰æ‰‹ã‚’å‹•ã‹ã—ãªãŒã‚‰å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®åŸºæœ¬çš„ãªä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
ã¾ãŸã€ã‚·ãƒ³ãƒ—ãƒ«ã«æ§‹ç¯‰ã—ãŸã‚‚ã®ãŒå‹•ä½œã™ã‚‹ã®ã‚’è¦‹ã‚‰ã‚Œã‚‹ã¨æ¥½ã—ã„ã§ã™ã­ã‡ï¼
æ¬¡ã®6ç« ã§ã¯ã‚¢ã‚»ãƒ³ãƒ–ãƒ©ã®å®Ÿè£…ã«ãªã‚Šã¾ã™ã€‚ã“ã¡ã‚‰ã¯åˆ¥é€”è¨˜äº‹ã«ã¾ã¨ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚
